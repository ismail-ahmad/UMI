<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MYM Knitwear - Stitching Operations Dashboard (Live)</title>
<style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
        font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
        color:#333; line-height:1.6; padding-bottom:40px;
    }
    .container { max-width:1400px; margin:0 auto; padding:20px; }
    .header {
        background:rgba(255,255,255,0.95);
        border-radius:20px; padding:24px; margin-bottom:20px;
        box-shadow:0 10px 30px rgba(0,0,0,0.2);
    }
    .header h1 { color:#2c3e50; font-size:2.1rem; margin-bottom:6px; font-weight:700;}
    .subtitle { color:#7f8c8d; font-size:1rem; margin-bottom:6px; }
    .meta { color:#95a5a6; font-weight:500; margin-bottom:12px; }
    .controls { display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin-top:10px;}
    .controls label { font-size:0.9rem; color:#2c3e50; display:flex; gap:8px; align-items:center; }
    .controls input[type="date"] {
        padding:8px 10px; border-radius:8px; border:1px solid #dcdcdc;
        background:#fff; font-size:0.95rem;
    }
    .controls button {
        padding:9px 14px; border-radius:10px; border:none; cursor:pointer;
        background:#2c3e50; color:#fff; font-weight:600;
    }
    .controls .small { padding:7px 10px; font-size:0.9rem; }

    .kpi-grid {
        display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
        gap:20px; margin:18px 0 26px 0;
    }
    .kpi-card {
        background:rgba(255,255,255,0.95); border-radius:15px; padding:18px;
        text-align:center; box-shadow:0 8px 25px rgba(0,0,0,0.15);
    }
    .kpi-card h3 { color:#34495e; font-size:0.9rem; margin-bottom:8px; text-transform:uppercase; letter-spacing:1px;}
    .kpi-value { font-size:1.9rem; font-weight:700; margin-bottom:6px; }
    .kpi-value.critical { color:#e74c3c; } .kpi-value.warning { color:#f39c12; } .kpi-value.good { color:#27ae60; }

    .insights-section {
        background:rgba(255,255,255,0.95); border-radius:15px; padding:22px; margin-bottom:30px;
        box-shadow:0 8px 25px rgba(0,0,0,0.15);
    }

    .line-performance {
        display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
        gap:16px; margin-top:18px;
    }
    .line-card { background:#fff; border-radius:10px; padding:14px; box-shadow:0 4px 15px rgba(0,0,0,0.1); transition:transform 0.2s ease;}
    .line-card:hover { transform:translateY(-3px); }
    .line-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .line-name { font-weight:700; color:#2c3e50; }
    .status-badge { padding:4px 10px; border-radius:20px; font-size:0.8rem; font-weight:700; text-transform:uppercase; }
    .status-badge.excellent { background:#d5f4e6; color:#27ae60; } 
    .status-badge.good { background:#fff3cd; color:#f39c12; } 
    .status-badge.critical { background:#f8d7da; color:#e74c3c; }
    .progress-bar { width:100%; height:8px; background:#ecf0f1; border-radius:4px; margin:8px 0; overflow:hidden;}
    .progress-fill { height:100%; border-radius:4px; transition:width 0.8s ease; }
    .progress-fill.excellent { background:#27ae60; } .progress-fill.good { background:#f39c12; } .progress-fill.critical { background:#e74c3c; }
    .small-muted { color:#6b7280; font-size:0.9rem; }
</style>
</head>

<body>
<div class="container">
    <div class="header">
        <h1>MYM KNITWEAR</h1>
        <div class="subtitle">Stitching Operations Performance Dashboard</div>
        <div class="meta" id="summaryRange">Showing latest data</div>

        <div class="controls">
            <label>From: <input type="date" id="fromDate"></label>
            <label>To: <input type="date" id="toDate"></label>
            <button id="loadBtn">Load Data</button>
            <button id="todayBtn" class="small">This Month</button>
            <button id="clearBtn" class="small">Clear</button>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card"><h3>Overall Achievement</h3><div class="kpi-value critical" id="kpiAchievement">—</div><div class="small-muted" id="kpiProdDetail">—</div></div>
        <div class="kpi-card"><h3>Average Efficiency</h3><div class="kpi-value critical" id="kpiEfficiency">—</div><div class="small-muted">Across lines</div></div>
        <div class="kpi-card"><h3>Average OEE</h3><div class="kpi-value warning" id="kpiOEE">—</div><div class="small-muted">Equipment effectiveness</div></div>
        <div class="kpi-card"><h3>Capacity Utilization</h3><div class="kpi-value good" id="kpiCapacity">—</div><div class="small-muted">SumMin / AvailableMin</div></div>
        <div class="kpi-card"><h3>Alteration Rate</h3><div class="kpi-value good" id="kpiAlteration">—</div><div class="small-muted">Alter / Actual Qty</div></div>
        <div class="kpi-card"><h3>Shortfall</h3><div class="kpi-value critical" id="kpiShortfall">—</div><div class="small-muted">Units below target</div></div>
    </div>

    <div class="insights-section">
        <h2 style="text-align:center;margin-bottom:18px;color:#2c3e50;">Line Performance</h2>
        <div id="linePerformance" class="line-performance"></div>
    </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz7fPoc8NI0HGDIX1ur_tI6BjZMuW0ARZB_2Dk4_iXNtVs7A5koeUOG7OT41___YtASKQ/exec";

// helper
function fmtPct(v){return isFinite(v)?v.toFixed(2)+'%':'0.00%';}
function fmtNum(v){return isFinite(v)?v.toLocaleString():'0';}
function setSummaryRangeText(from,to){
    const el=document.getElementById('summaryRange');
    if(from&&to)el.textContent=`Showing data from ${from.toLocaleDateString()} to ${to.toLocaleDateString()}`;
    else el.textContent='Showing latest data';
}

async function loadData(from,to){
    try{
        document.getElementById('loadBtn').textContent='Loading...';
        const res=await fetch(SCRIPT_URL);
        const data=await res.json();

        let fromDate=from?new Date(from):null;
        let toDate=to?new Date(to):null;
        if(toDate)toDate.setDate(toDate.getDate()+1); // include last day

        const filtered=data.filter(r=>{
            const d=new Date(r['Date']);
            return (!fromDate||d>=fromDate)&&(!toDate||d<toDate);
        });

        processRecords(filtered);
        document.getElementById('loadBtn').textContent='Load Data';
    }catch(e){
        alert('Error loading data');
        console.error(e);
    }
}

function processRecords(rows){
    if(!rows.length){alert('No data in this range');return;}
    let totalPred=0,totalAct=0,totalAlt=0,sumEff=0,sumOee=0,sumMin=0,sumAvail=0,cEff=0,cOee=0;
    const byLine={};

    rows.forEach(r=>{
        const line=r['Line']||'Unknown';
        const pred=+r['Predicted Qty']||0;
        const act=+r['Actual Qty']||0;
        const eff=+r['Efficiency %']||0;
        const oee=+r['OEE %']||0;
        const alt=+r['Alter Qty']||0;
        const sm=+r['Sum Minutes']||0;
        const av=+r['Available Minutes']||0;
        totalPred+=pred; totalAct+=act; totalAlt+=alt; sumEff+=eff; sumOee+=oee;
        sumMin+=sm; sumAvail+=av; cEff++; cOee++;
        if(!byLine[line])byLine[line]={pred:0,act:0,eff:[],oee:[],alt:0};
        byLine[line].pred+=pred; byLine[line].act+=act; byLine[line].eff.push(eff); byLine[line].oee.push(oee); byLine[line].alt+=alt;
    });

    const ach=totalPred?(totalAct/totalPred)*100:0;
    const effAvg=sumEff/cEff;
    const oeeAvg=sumOee/cOee;
    const cap=sumAvail?(sumMin/sumAvail)*100:0;
    const altAvg=totalAct?(totalAlt/totalAct)*100:0;
    const shortfall=totalPred-totalAct;

    document.getElementById('kpiAchievement').textContent=fmtPct(ach);
    document.getElementById('kpiProdDetail').textContent=`${fmtNum(totalAct)} / ${fmtNum(totalPred)} units`;
    document.getElementById('kpiEfficiency').textContent=fmtPct(effAvg);
    document.getElementById('kpiOEE').textContent=fmtPct(oeeAvg);
    document.getElementById('kpiCapacity').textContent=fmtPct(cap);
    document.getElementById('kpiAlteration').textContent=fmtPct(altAvg);
    document.getElementById('kpiShortfall').textContent=fmtNum(shortfall>0?shortfall:0);

    const lines=document.getElementById('linePerformance');
    lines.innerHTML='';
    Object.keys(byLine).forEach(l=>{
        const data=byLine[l];
        const eAvg=data.eff.reduce((a,b)=>a+b,0)/data.eff.length;
        const oAvg=data.oee.reduce((a,b)=>a+b,0)/data.oee.length;
        const achL=data.pred?(data.act/data.pred)*100:0;
        const altL=data.act?(data.alt/data.act)*100:0;
        let cls='critical',txt='Critical';
        if(eAvg>=70){cls='excellent';txt='Excellent';}
        else if(eAvg>=50){cls='good';txt='Good';}
        const card=document.createElement('div');
        card.className='line-card';
        card.innerHTML=`
        <div class="line-header"><div class="line-name">${l}</div><div class="status-badge ${cls}">${txt}</div></div>
        <div><strong>Production:</strong> ${fmtNum(data.act)} / ${fmtNum(data.pred)} units</div>
        <div class="progress-bar"><div class="progress-fill ${cls}" style="width:${Math.min(achL,100)}%"></div></div>
        <div style="font-size:0.9rem;margin-top:6px;">
            Efficiency: ${fmtPct(eAvg)} | OEE: ${fmtPct(oAvg)}<br>
            Achievement: ${fmtPct(achL)} | Alterations: ${fmtPct(altL)}
        </div>`;
        lines.appendChild(card);
    });
}

// Buttons
document.getElementById('loadBtn').onclick=()=>{
    const f=document.getElementById('fromDate').value;
    const t=document.getElementById('toDate').value;
    setSummaryRangeText(f?new Date(f):null,t?new Date(t):null);
    loadData(f,t);
};

document.getElementById('todayBtn').onclick=()=>{
    const now=new Date();
    const first=new Date(now.getFullYear(),now.getMonth(),1);
    const last=new Date(now.getFullYear(),now.getMonth()+1,0);
    document.getElementById('fromDate').value=first.toISOString().slice(0,10);
    document.getElementById('toDate').value=last.toISOString().slice(0,10);
    setSummaryRangeText(first,last);
    loadData(first.toISOString().slice(0,10),last.toISOString().slice(0,10));
};

document.getElementById('clearBtn').onclick=()=>{
    document.getElementById('fromDate').value='';
    document.getElementById('toDate').value='';
    setSummaryRangeText(null,null);
    loadData('','');
};

window.addEventListener('DOMContentLoaded',()=>loadData('',''));
</script>
</body>
</html>
